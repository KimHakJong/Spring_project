<?xml version="1.0" encoding="UTF-8" ?>

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.gant.myhome.mybatis.mapper.TodolistMapper">
     
 	 
	 
	<select id="getListCount" resultType="int">
		select count(*) from todolist
	</select>	
	
	<select id="get_name" resultType="String">
		select p_mnames from project where p_no = #{p_no}
	</select>	
		
	<select id="get_id" resultType="String">
		select p_mids from project where p_no = #{p_no}
	</select>	
	

	<!--  문법오류
			rnum >= #{start}
			=> 해결법
			 1. where rnum &gt;= #{start}
			 2. where rnum <![CDATA[ >= ]]> #{start}
			 
			=> 설명
				1. HTML 문서 '<', '>'와 같은 마크업 문자들을 파싱해서 읽어들이는 구조입니다.
				그래서 마크업 문자( < 작다, > 크다)로 사용하기 위해서
				'&lt' '&gt'등의 escape 문자열(escape character)을 이용해야합니다.
				
					< &lt
					> &gt
				
				2. CDATA(character data) - XML파서가 분석하지 않는 문자 데이터를 의미합니다.
											사용법은 <![CDATA[ 와 ]] 사이에 문자들을 넣으면 됩니다.
											
											
				
			  -->

	<select id="getTodolist" resultType="Todolist">
	select * from todolist 
	where rownum &gt;= #{start} and rownum &lt;= #{end} and p_no = #{p_no}
	</select>
	<!-- jdbcType=VARCHAR: 첨부파일을 추가 하지 않은 경우 에러 처리해줍니다.
							해당 필드가 NULL 인경우 jdbcType=VARCHAR로 처리하면 null로 설정됩니다.
							
		insert전에 (order="before")
		조회 (select nvl(max(BOARD_NUM), 0)+1 from board) 합니다.
		
		조회한 값을 keyProperty="BOARD_NUM"에서 설정한대로 BOARD_NUM 프로퍼티에 저장합니다.
		(public void setBOARD_NUM(int BOARD_NUM))
		insert 문의 #{BOARD_NUM}는 지금 구한 값을 BoardBean에서 가져옵니다.
		(public void getBOARD_NUM() {return BOARD_NUM;})
		  
		-->	
	
	<insert id = "insertBoard">
		<selectKey resultType="int" order="BEFORE" keyProperty="BOARD_NUM">
			select nvl(max(BOARD_NUM), 0)+1 from board3	
		</selectKey>
		insert into board3(BOARD_NUM, BOARD_NAME, BOARD_PASS, BOARD_SUBJECT, BOARD_CONTENT, BOARD_FILE, BOARD_ORIGINAL, BOARD_RE_REF, BOARD_RE_LEV, BOARD_RE_SEQ, BOARD_READCOUNT, BOARD_DATE)
		values(#{BOARD_NUM}, #{BOARD_NAME}, #{BOARD_PASS}, #{BOARD_SUBJECT}, #{BOARD_CONTENT}, #{BOARD_FILE, jdbcType=VARCHAR}, #{BOARD_ORIGINAL, jdbcType=VARCHAR}, #{BOARD_NUM}, #{BOARD_RE_LEV}, #{BOARD_RE_SEQ}, #{BOARD_READCOUNT}, sysdate)
	</insert>
	
	<update id="setReadCountUpdate">
		update board3 set BOARD_READCOUNT=BOARD_READCOUNT+1 where BOARD_NUM=#{number}
	</update>
	
	<select id="getDetail" resultType="board">
		select * from board3 where BOARD_NUM = #{number}
	</select>
	
	<!--  map은 java.util.Map의 별칭 -->
	
	<select id="isBoardWriter" resultType="board">
		select * from board3 where BOARD_NUM = #{num} and BOARD_PASS=#{pass}
	</select>
	
	<update id="boardModify">
      update board3
      set BOARD_SUBJECT = #{BOARD_SUBJECT},
         BOARD_CONTENT = #{BOARD_CONTENT},
         BOARD_FILE = #{BOARD_FILE},
         BOARD_ORIGINAL = #{BOARD_ORIGINAL}
         
      where BOARD_NUM=#{BOARD_NUM}
   </update>
   
   <update id="boardReplyUpdate">
   	update board3 set BOARD_RE_SEQ=BOARD_RE_SEQ+1 WHERE BOARD_RE_REF=#{BOARD_RE_REF} and BOARD_RE_SEQ<![CDATA[>]]> #{BOARD_RE_SEQ}
   </update>
   
	<insert id = "boardReply">
		<selectKey resultType="int" order="BEFORE" keyProperty="BOARD_NUM">
			select nvl(max(BOARD_NUM), 0)+1 from board3	
		</selectKey>
		insert into board3(BOARD_NUM, BOARD_NAME, BOARD_PASS, BOARD_SUBJECT, BOARD_CONTENT, BOARD_RE_REF, BOARD_RE_LEV, BOARD_RE_SEQ, BOARD_READCOUNT, BOARD_DATE)
		values(#{BOARD_NUM}, #{BOARD_NAME}, #{BOARD_PASS}, #{BOARD_SUBJECT}, #{BOARD_CONTENT}, #{BOARD_RE_REF}, #{BOARD_RE_LEV}, #{BOARD_RE_SEQ}, #{BOARD_READCOUNT}, sysdate)
	</insert>
	
	<delete id="boardDelete">
	<![CDATA[
		delete from board3
			where BOARD_RE_REF=#{BOARD_RE_REF}
			and BOARD_RE_LEV>=#{BOARD_RE_LEV}
			and BOARD_RE_SEQ>=#{BOARD_RE_SEQ}
			and BOARD_RE_SEQ <= ( nvl((SELECT min(board_re_seq)-1 FROM BOARD3 
											where BOARD_RE_REF=#{BOARD_RE_REF}
											and BOARD_RE_LEV=#{BOARD_RE_LEV}
											and BOARD_RE_SEQ>#{BOARD_RE_SEQ}),
											(SELECT max(board_re_seq) FROM BOARD3 WHERE BOARD_RE_REF = #{BOARD_RE_REF})))
	
	]]>
	</delete>
	
	<select id="getDeleteFileList" resultType="String">
		select board_file from delete_file
	</select>
	
	<delete id="deleteFileList">
		delete delete_file where board_file=#{file_name}
	</delete>
       
</mapper>

<?xml version="1.0" encoding="UTF-8" ?>
<!-- SQL맵퍼파일은 xml이기 때문에 제일먼저 xml선언이 옵니다. -->
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!--  Mapper 인터페이스의 패키지 명과 이름을 namespace로 설정합니다. -->
<mapper namespace="com.gant.myhome.mybatis.mapper.BoardMapper">
     
     <!-- 
		1. 태크에 id 속성은 Mapper 인터페이스에 추가한 메서드명과 동일하게 작성됩니다.
		2. resultType속성은 연동시킬 메서드에 명시된 반환 타입을 작성해 줍니다.
		-->
     
     <select id="getListCount" resultType="int">
        select count(*) from board3
     </select>
     
            
      <select id="getBoardList"  resultType="board">
       select *
        from (select rownum rnum, b.*
              from (select board3.* , nvl(cnt,0) as cnt 
                    from board3 left outer join (select board_num ,count(*) as CNT
                                                 from comments3
                                                 group by board_num)j
                   on board3.BOARD_NUM = j.board_num
                   order by BOARD_RE_REF desc,
			       BOARD_RE_SEQ asc) b 
              where rownum &lt;= #{end}
               )
        where rnum  &gt;= #{start} and rnum &lt;= #{end}        
      </select>
      
     
      <insert id="insertBoard" >
        <selectKey resultType="int" order="BEFORE" keyProperty="BOARD_NUM">
            select nvl(max(BOARD_NUM),0)+1 from board3            
        </selectKey>
           insert into board3  
          (BOARD_NUM,     BOARD_NAME,   BOARD_PASS,  BOARD_SUBJECT,
		   BOARD_CONTENT, BOARD_FILE, BOARD_ORIGINAL, BOARD_RE_REF,   
		   BOARD_RE_LEV,  BOARD_RE_SEQ, BOARD_READCOUNT,BOARD_DATE) 
		   values
		   (#{BOARD_NUM} ,#{BOARD_NAME}, #{BOARD_PASS}, #{BOARD_SUBJECT},
		   #{BOARD_CONTENT}, #{BOARD_FILE , jdbcType=VARCHAR}, #{BOARD_ORIGINAL , jdbcType=VARCHAR}, #{BOARD_NUM},
		   #{BOARD_RE_LEV}, #{BOARD_RE_SEQ}, #{BOARD_READCOUNT},sysdate) 
      </insert>
      
      
      <update id="setReadCountUpdate" >
	        update board3
	       set BOARD_READCOUNT = BOARD_READCOUNT+1
	       where BOARD_NUM = #{number}
      </update>
      
     
      <select id="getDetail" resultType="board">
	      select *
	      from board3
	      where BOARD_NUM = #{number}
      </select>
      
      <select id="isBoardWriter"  resultType="board">
        select * from board3
        where BOARD_NUM = #{num}
        and BOARD_PASS = #{pass}
      </select>
      
      
      <update id="boardModify">
        update board3
        set
               BOARD_SUBJECT = #{BOARD_SUBJECT},
               BOARD_CONTENT = #{BOARD_CONTENT},
               BOARD_FILE = #{BOARD_FILE , jdbcType=VARCHAR},
               BOARD_ORIGINAL = #{BOARD_ORIGINAL , jdbcType=VARCHAR}
        where  BOARD_NUM = #{BOARD_NUM}            
      </update>
      
      <update id="boardReplyUpdate">
        update board3
        set    BOARD_RE_SEQ = BOARD_RE_SEQ+1
        where  BOARD_RE_REF = #{BOARD_RE_REF}             
        and    BOARD_RE_SEQ <![CDATA[ > ]]> #{BOARD_RE_SEQ}     
      </update>   
      
      <insert id="boardReply">
         <selectKey resultType="int" order="BEFORE" keyProperty="BOARD_NUM">
            select nvl(max(BOARD_NUM),0)+1 from board3            
        </selectKey>
          insert into board3  
          (BOARD_NUM,     BOARD_NAME,   BOARD_PASS,  BOARD_SUBJECT,
		   BOARD_CONTENT, BOARD_RE_REF,   
		   BOARD_RE_LEV,  BOARD_RE_SEQ, BOARD_READCOUNT,BOARD_DATE) 
		   values
		   (#{BOARD_NUM} ,#{BOARD_NAME}, #{BOARD_PASS}, #{BOARD_SUBJECT},
		   #{BOARD_CONTENT},#{BOARD_RE_REF},
		   #{BOARD_RE_LEV}, #{BOARD_RE_SEQ}, #{BOARD_READCOUNT},sysdate)
      </insert>
      

      
      <delete id="boardDelete">
       <![CDATA[
                     delete from board3 
				     where BOARD_RE_REF = #{BOARD_RE_REF}  
				     and BOARD_RE_LEV >= #{BOARD_RE_LEV} 
				     and BOARD_RE_SEQ >= #{BOARD_RE_SEQ} 
				     and BOARD_RE_SEQ <=( nvl((select min(BOARD_RE_SEQ)-1 
				                         from board3 
				                         where BOARD_RE_REF = #{BOARD_RE_REF}
				                         and BOARD_RE_LEV = #{BOARD_RE_LEV} 
				                         and BOARD_RE_SEQ > #{BOARD_RE_SEQ}), 
				                         (select max(BOARD_RE_SEQ) 
				                          from board3 
				                          where BOARD_RE_REF = #{BOARD_RE_REF})) 
				                        )
		]]>		                              
      </delete>
      
      
       <select id="getDeleteFileList" resultType="String">
       select board_file
       from delete_file
      </select>
      
      <delete id="deleteFileList" parameterType="String">
        delete from delete_file
        where board_file = #{filename}
      </delete>
      
       
</mapper>
